{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block header %}
    <link rel="stylesheet" href="{% static "board/css/board_header.css" %}" type="text/css">
    <div class="board__header__search">
        <form action="" method="get">
            <button type="submit" value="search">
                <img src="{% static "/svg/search.svg" %}">
            </button>
            <input type="text" placeholder="Search mycampus" name="search" value="{{ search }}">
        </form>
    </div>
    <div class="board__header__right">
        <ul class="board__buttons">
            <li><img src="{% static "/svg/alarm.svg" %}"></li>
            <li><img src="{% static "/svg/messege box.svg" %}"></li>
            <li><img src="{% static "/svg/mypage.svg" %}"></li>
            <li><img id="h__post" src="{% static "/svg/post.svg" %}">
            </li>
        </ul>
    </div>
{% endblock %}

{##}
{#{{ univ.full_name }} <br>#}
{#{{ univ.short_name }} <br>#}
{#{% for category in categories %}#}
{#  {{ category.name }}#}
{#{% endfor %}#}

{% block contents %}
    <link rel="stylesheet" href="{% static "board/css/main_board.css" %}" type="text/css">
    <div class="board__pannel__top container">
      <a href="{% url 'core:board:main_board_new' univ.url_name %}">
      {% if state == 'new' %}
        <img src="{% static "/svg/버튼2.svg"%}">
      {% else %}
        <img src="{% static "/svg/버튼3.svg"%}">
      {% endif %}
      </a>
      <a href="{% url 'core:board:main_board' univ.url_name %}">
      {% if state == 'hot' %}
        <img src="{% static "/svg/버튼4.svg"%}">
      {% else %}
        <img src="{% static "/svg/버튼1.svg"%}">
      {% endif %}
      </a>
    </div>
    

    <div class="container board__main">


        <div class="board__pannel__left">
            <ul>
                {% for post in posts %}
                    <div>
                        <li class="board__post__container">

                            <div class="board__post__like">
                                <span id="post_{{ post.pk }}">{{ post.total_likes }}</span>

                                <button type="button" class="like" name="{{ post.pk }}" value="Like">
                                  {% if user in post.likes.all %}
                                    <img id="like_id_{{ post.pk }}" class='clicked' src="{% static "/svg/like-clicked.svg" %}"/>
                                  {% else %}
                                    <img id="like_id_{{ post.pk }}" src="{% static "/svg/like.svg" %}"/>
                                  {% endif %}

                                </button>
                            </div>

                            <div class="board__post__content">
                                <div class="post__text">
                                    <div class="post__top">
                                        <div class="post__top__category">
                                            {{ post.ctgy.name }}
                                        </div>
                                        <div class="post__top__author">
                                            {{ post.name }}
                                        </div>
                                    </div>
                                    <div class="post__mid">
                                        <div class="post__mid__title">
                                            <a href="{% url 'core:board:post_detail' univ.url_name post.ctgy.name post.pk %}">{{ post.title }}</a>
                                        </div>
                                        <div class="post__mid__content">
                                            {{ post.content }}
                                        </div>
                                    </div>
                                    <hr/>
                                    <div class="post__bottom">
                                        <div class="post__bottom__icon">
                                            <div class="s_con post__bottom__view">
                                            {% if user in post.viewed_by.all %}
                                                <img src="{% static "/svg/view-clicked.svg" %}"/>
                                            {% else %}
                                                <img src="{% static "/svg/view.svg" %}"/>
                                            {% endif %}
                                                <span>{{post.views}}</span>
                                            </div>
                                            <div class="s_con post__bottom__comment">
                                            {% if user.pk in post.comments_author %}
                                                <img src="{% static "/svg/comment-clicked.svg" %}"/>
                                            {% else %}
                                                <img src="{% static "/svg/comment.svg" %}"/>
                                            {% endif %}
                                                <span>{{ post.comments.all.count }}</span>
                                            </div>
                                            <div class="s_con post__bottom__bookmark">
                                                {% if user in post.saved.all %}
                                                    <img src="{% static "/svg/bookmark.svg" %}"/>
                                                {% else %}
                                                <img src="{% static "/svg/scrap.svg" %}"/>
                                                {% endif %}
                                                <span>{{ post.saved.all.count }}</span>
                                            </div>
                                        </div>
                                        <div class="post__bottom__time">
                                            {{ post.created_at|naturaltime }}
                                        </div>
                                        {##}
                                        {##}
                                        {#         {% if user in post.saved.all %}#}
                                        {#                                            <input type="button" class="bookmark" name="{{ post.pk }}" value="O">#}
                                        {#                                        {% else %}#}
                                        {#                                            <input type="button" class="bookmark" name="{{ post.pk }}" value="X">#}
                                        {#                                        {% endif %}#}

                                    </div>
                                </div>

                                <div class="post__image">

                                </div>

                            </div>
                        </li>
                    </div>
                {% endfor %}
            </ul>
        </div>

        <div class="board__pannel__right">
            <a href="{% url 'core:board:post_create' univ.url_name %}">
                <div class="pannel__right__create">
                    <img src="{% static "svg/create post.svg/" %}" alt="">
                    <p>Create Post</p>
                </div>
            </a>
            <div class="pannel__right__category">
                <p>Category</p>
                <ul class="right__category__list">
                    {% for category in categories %}
                        <li class="{% cycle "c_a" "c_b" "c_c" "c_d" %}">
                            <a id="category__a" href="{% url 'core:board:category_board' univ.url_name category.name %}">
                                <span class="c_common">
                                    {{ category.name }}
                                </span>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>

    <script>
        sb.connect("{{ user.username }}", async function (user, error) {
            if (error) return;
        });

        $('.like').click(function () {
            var pk = $(this).attr('name')
            var like_img = document.getElementById(`like_id_${pk}`);
            console.log(like_img.classList.contains('clicked'));
            if (!(like_img.classList.contains('clicked'))) {
              like_img.src="/static/svg/like-clicked.svg";
              like_img.setAttribute('class','clicked');
            } else {
              like_img.src="/static/svg/like.svg";
              like_img.removeAttribute('class','clicked');
            }




            const univUrlName = "{{ univ.url_name }}";
            const url = '{% url 'core:board:post_like' 0 %}'.replace('0', univUrlName);
            $.ajax({
                type: 'POST',
                url: url,
                data: {
                    'pk': $(this).attr('name'),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    url_name: univUrlName
                },
                datatype: "json",
                success: function (response) {
                    $(`#post_${response['pk']}`).text(response['likes_count']);
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            })
        });


        $('.bookmark').click(function () {
            const url = '{% url 'core:board:post_bookmark' 0 %}'.replace('0', "{{ univ.url_name }}");
            $.ajax({
                type: 'POST',
                url: url,
                data: {
                    'pk': $(this).attr('name'),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    url_name: url,
                },
                datatype: "json",
                success: function (response) {
                    console.log(200)
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            })
        });
    </script>
{% endblock %}
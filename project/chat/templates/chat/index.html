{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static "chat/css/index.css" %}" type="text/css">
{% endblock %}
{% block contents %}
<div class="container chat-container">
    <div id="chat-list-container">
        <div id="chat-list-header">
            Messenger
        </div>
        <hr width=100%>
        <input id="chat-search" type="text" placeholder="Search Messenger">
        <ul id='chat-list'>
        </ul>
    </div>
    <div id="chat-main">
        <div id='chat-header'>
            none
        </div>
        <hr width=100%>
        <ul id='chat-box' url='none' with='none'>

        </ul>
        <hr width=100%>
        <div id="chat-input">
            <input type="text" id="chat-text" placeholder="Please enter a message">
            <button type="submit" id="chat-text-btn">
                <img src="{% static "/svg/send message.svg"%}" alt="">
            </button>
        </div>
    </div>
</div>
{% endblock contents %}

{% block javascript %}
<script>
    const chat_list = document.getElementById('chat-list')
    const chat_header = document.getElementById('chat-header')
    const chat_box = document.getElementById('chat-box')
    const chat_text = document.getElementById('chat-text')
    const chat_search = document.getElementById('chat-search')
    const chat_text_btn = document.getElementById('chat-text-btn')
    let flag = 'norm'


    sb.connect("{{ user.username }}", async function (user, error) {
        if (error) return;
        const channels = await loadChatList()
        const first_btn = await renderChatList(channels, chat_list, chat_header, chat_box)
        if(first_btn) first_btn.click()
    });

    chat_search.addEventListener('keypress', async (e) => {
        if (e.key == "Enter" && chat_search.value != "") {
            flag = 'norm'
            try {
                await openAChat(chat_search.value, flag)
                const channels = await loadChatList()
                const first_btn = await renderChatList(channels, chat_list, chat_header, chat_box)
                first_btn.click()
            } catch (e) {
                console.log(e)
                alert('check username')
            }
        }
    })
    chat_search.addEventListener('click', async (e) => {
        if (chat_search.value != "") {
            flag = 'anon'
            try {
                await openAChat(chat_search.value, flag)
                const channels = await loadChatList()
                const first_btn = await renderChatList(channels, chat_list, chat_header, chat_box)
                first_btn.click()
            } catch (e) {
                console.log(e)
                alert('check username')
            }
        }
    })
    chat_text.addEventListener('keypress', async (e) => {
        if (e.key == 'Enter' && chat_box.getAttribute('url') != 'none' && chat_text.value != "") {
            sb.GroupChannel.getChannel(chat_box.getAttribute('url'), async (groupChannel, error) => {
                if (error) return
                groupChannel.sendUserMessage(chat_text.value, async (message, error) => {
                    if (error) return
                    chat_box.innerHTML += strfy(message, groupChannel.customType)
                    chat_box.scrollTop = chat_box.scrollHeight;
                    chat_text.value = ""
                    const channels = await loadChatList()
                    await renderChatList(channels, chat_list,
                        chat_header, chat_box)
                })
            })
        }
    })

    chat_text_btn.addEventListener('click', async (e) => {
        if (chat_text.value != "") {
            sb.GroupChannel.getChannel(chat_box.getAttribute('url'), async (groupChannel, error) => {
                if (error) return
                groupChannel.sendUserMessage(chat_text.value, async (message, error) => {
                    if (error) return
                    chat_box.innerHTML += strfy(message, groupChannel.customType)
                    chat_box.scrollTop = chat_box.scrollHeight;
                    chat_text.value = ""
                    const channels = await loadChatList()
                    await renderChatList(channels, chat_list,
                        chat_header, chat_box)
                })
            })
        }
    })
</script>
{% endblock javascript %}
{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static "chat/css/index.css" %}" type="text/css">
{% endblock %}
{% block contents %}
<div id="chat_container">
    <div class="chat_left">
        <div class="chat_list_headr">
            messanger
        </div>
        <input class="chat_search" type="text">
        <ul id='chat_list'>
        </ul>
    </div>
    <div id="chat_right">
        <div id='chat_header'>

        </div>
        <ul id='chat_room' url='none' with='none'>

        </ul>
        <div class="chat_input">
            <input type="text" id="message">
            <input type="submit" id="m_submit">
        </div>
    </div>
</div>
{% endblock contents %}

{% block javascript %}
<script>
    const chat_list = document.getElementById('chat_list')
    const chat_header = document.getElementById('chat_header')
    const chat_room = document.getElementById('chat_room')
    const chat_text = document.getElementById('message')
    const m_btn = document.getElementById('m_submit')
    const other = document.getElementById('other')
    const flag = document.getElementById('flag')
    const submit = document.getElementById('submit')


    sb.connect("{{ user.username }}", async function (user, error) {
        if (error) return;
        const channels = await loadChatList()
        if (channels.length) {
            channels.forEach(cur => addChannelBtn(cur, chat_list, cur.customType))
            const buttons = [...chat_list.querySelectorAll('.url')]
            buttons.forEach(cur => {
                setChannelBtn(cur, chat_header, chat_room)
            })
        }
    });

    chat_text.addEventListener('keypress', async (e) => {
        if (e.key == 'Enter' && chat_room.getAttribute('url') != 'none') {
            sb.GroupChannel.getChannel(chat_room.getAttribute('url'), (groupChannel, error) => {
                if (error) return
                groupChannel.sendUserMessage(chat_text.value, (message, error) => {
                    if (error) return
                    chat_room.innerHTML += strfy(message, groupChannel.customType)
                    chat_room.scrollTop = chat_room.scrollHeight;
                })
            })
        }
    })

    m_btn.addEventListener('click', async (e) => {
        sb.GroupChannel.getChannel(chat_room.getAttribute('url'), (groupChannel, error) => {
            if (error) return
            groupChannel.sendUserMessage(chat_text.value, (message, error) => {
                if (error) return
                chat_room.innerHTML += strfy(message, groupChannel.customType)
                chat_room.scrollTop = chat_room.scrollHeight;
            })
        })
    })
</script>
{% endblock javascript %}
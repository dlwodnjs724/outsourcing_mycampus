{% extends 'base.html' %}
{% load static %}

{% block contents %}
<div id='chat'>
    <div id='title'>
        {{user}}'s chat with {{partner}}
    </div>
    <div id='chat_room' style="overflow:scroll; width:500px; height:150px;">

    </div>
    <div class="form">
        <input type="text" id="message">
        <input type="submit" id="m_submit">
    </div>
</div>
{% endblock contents %}

{% block javascript %}

<script>
    const chat_room = document.getElementById('chat_room')
    const m_btn = document.getElementById('m_submit')

    sb.connect("{{ user.username }}", async function (user, error) {
        if (error) return;
        const chats = await loadChatList(sb)
        const target_server = chats.filter(cur => cur.members.filter(_cur => _cur.userId == "{{partner}}"))[0]
        chat_room.innerHTML = await loadLog(target_server,10)
        chat_room.scrollTop = chat_room.scrollHeight;
    });

    m_btn.addEventListener('click', async (e) => {
        const chats = await loadChatList(sb)
        const target = chats.filter(cur => cur.members.filter(cur => cur.userId == "{{partner}}").length)[0]

        sb.GroupChannel.getChannel(target.url, function (groupChannel, error) {
            if (error) return;
            groupChannel.sendUserMessage(document.getElementById('message').value, function (message,
                error) {
                if (error) return;
                chat_room.innerHTML += strfy(message)
                chat_room.scrollTop = chat_room.scrollHeight;
            });
        });
    });
</script>

{% endblock javascript %}